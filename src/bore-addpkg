# adds a port
# params: $pkgname
addpkg() {
    [ "$(ls $ports | wc -l)" -gt 0 ] || die "addpkg(): no ports found"

    pkgname=$1
    pkgfile="$ports"/$pkgname/pkgfile
    isinst $pkgname > /dev/null && die "port $pkgname is already installed"

    . "$pkgfile" || die "addpkg(): can't source $pkgname's pkgfile?"

    [ -z "$version" ] && version='unknown'

    pkgid="${pkgname}${delim}${version}"
    pkgdir="$work"/"$pkgid"

    get "$source" $pkgname "$version"

    cd "$pkgdir" || die "addpkg(): unable to cd to $pkgdir"

    msg "building $pkgname..."
    mkdir -p "$pkgs"/$pkgname

    if run_build $pkgname ; then
        sanity_check && rm -rf "$pkgdir"
        link_pkg $pkgname
        clear_junk $pkgname
        add_db $pkgname $version
        msg "$pkgname installed!"
        clean
    fi
    unset pkg{name,file,dir,id}
}

# create symlinks for a port
# params: $pkgname
link_pkg() {
    sanity_check
    pkgname=$1
    cd "$borehome"
    cd ..
    msg 'creating symlinks...'
    for dir in bin sbin share include etc lib libexec ; do
        # recursively create pkg subdirectories in
        # equivalent /root subdirectories
        # example: $pkgname/lib/pkgconfig -> /lib/pkgconfig
        find "$pkgs"/$pkgname/$dir ! -path "*$dir" ! -path "*share/*man*" \
            -type d 2> /dev/null | while read -r subdir ; do
            mkdir -p "${subdir#$pkgs/$pkgname/}"
        done
        # recursively link all files
        # example: $pkgname/include/asm/*.h -> /include/asm/*.h
        find "$pkgs"/$pkgname/$dir ! -path "*share/*man*" \
            -type f -o -type l 2> /dev/null | while read -r file ; do
            file="${file#$pkgs/$pkgname/}"

            # BUG: important: this is /src/pkgs not $pkgs for
            #      now until I find a pathing fix!
            # ln -sf "/src/pkgs/$pkgname/$file" ./$file
            ln -sf "$pkgs/$pkgname/$file" ./$file

        done
    done
    $mans && # only link mans if config boolean is true
    if [ -d "$pkgs"/$pkgname/share/man ] ; then
        for manX in $(seq -f "man%g" -s " " 1 8) ; do
            find "$pkgs"/$pkgname/share/man/$manX \
                ! -path "*/$manX" 2> /dev/null | while read -r man ; do
                man="${man#$pkgs/$pkgname/}"
                ln -sf "/src/pkgs/$pkgname/share/man/$manX/${man##*/}" "$man"
            done
        done
    fi
    unset pkgname dir subdir file manX man
}
