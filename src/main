# vi:syntax=sh
# shellcheck shell=sh

# unset any env variables that could interfere
unset cc c99 c89 CC \
CFLAGS LDFLAGS CPPFLAGS CXXFLAGS PKG_CONFIG \
LIBRARY_PATH CPATH C_INCLUDE_PATH CPLUS_INCLUDE_PATH \
OBJC_INCLUDE_PATH LD_LIBRARY_PATH LIBDIR EXTRALIBDIR \
LIBS INCLUDE

initglobals() {
    case "$1" in
        # If bootstrapping, relinking the world, or chrooting,
        # use the host's userland. When bootstraping, programs
        # will take preference in the $PATH as they install.
        USE_HOST_PATH)
            PKG_CONFIG_PATH="$root/lib/pkgconfig:/lib/pkgconfig"
            PATH=".:$root/bin:$PATH"
            ;;
        *)  # otherwise if not bootstrapping, ONLY use the chroot's tools
            PKG_CONFIG_PATH="$root/lib/pkgconfig"
            PATH=".:$root/bin"
    esac

    # can offer significant speedup
    LC_ALL=C
    LANG=C

    export PATH PKG_CONFIG_PATH LC_ALL LANG
}

main() {
    # if no arguments, just print a pretty tree
    [ "$1" ] || { print_logo ; exit ; }

    # load config and setup the environment
    case "$1" in
        *help|-h|*skeleton|skel) ;; # no need to load config
        --bootstrap)
            BOOTSTRAP=true
            export BOOTSTRAP
            loadconfig
            initglobals USE_HOST_PATH
            set -- add bonsai-core
            ;;
        --config=*)
            bonsairc="${1#--config=}"
            export bonsairc
            loadconfig
            initglobals
            shift
            ;;
        *relink*world|chroot)
            loadconfig
            initglobals USE_HOST_PATH
            ;;
        *) loadconfig
           initglobals
    esac
    
    while [ "$1" ] ; do
        case "$1" in
            # ---- variable setting -------
            *debug) set -x ; shift ;;
            *errexit) set -e ; shift ;;
            *dlonly) DLONLY=true ; export DLONLY ; shift ;;
            --root) ROOT="${1#--root=}" ; export ROOT ; shift ;;
            --gcc) GCC="${1#--gcc=}" ; export GCC ; shift ;;
            -y) NO_PROMPT=true ; export NO_PROMPT ; shift ;;
            *host*curl) HOSTS_CURL=true ; export HOSTS_CURL ; shift ;;
            # -----------------------------
            *relink*world) relink_world "$2" ; exit $? ;;
            *skeleton|skel) create_skeleton_config "$2" ; exit $? ;;
            chroot)    enter_chroot  ; exit $? ;;
            list|-l)   listpkgs      ; exit $? ;;
            search|-s) search "$2"   ; exit $? ;;
            info|-i)   portinfo "$2" ; exit $? ;;
            print|-p)  portcat "$2"  ; exit $? ;;
            count)     countpkgs     ; exit $? ;;
            pack)      pack "$2"     ; exit $? ;;
            add|-a) shift ; addpkg "$@" ; exit $? ;;
            del|-d) shift ; delpkg "$@" ; exit $? ;;
            *help|-h) usage ; exit ;;
            relink|-r)
                shift
                while [ "$1" ] ; do
                    linkpkg "$1"
                    shift
                done
                ;;
            isinst)
                shift
                while [ "$1" ] ; do
                    isinst "$1"
                    shift
                done
                ;;
            deps)
                pkgdeps "$2"
                if [ "$pkgdeps" ] ; then
                    msg "$pkgdeps"
                    exit $?
                else
                    msg "port $2 has no dependencies"
                    exit 1
                fi
                ;;
            *)
                
                if [ "$1" ] ; then
                    # If none matched and there is an argument,
                    # we must be adding a package
                    # and omitting the 'add' (convenience).
                    # recurse again, adding the 'add' argument
                    set -- add "$@"
                else
                    # otherwise must have no arguments
                    # just print a pretty tree
                    bonsai
                fi
        esac
    done
}
