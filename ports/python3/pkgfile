version=3.7.4
info="$name${version%.*} scripting language interpreter"
source=http://github.com/python/cpython/archive/v$version.tar.gz
deps='netbsd-curses libedit libressl bzip2 zlib'
sha256=aaea286c4458f22125e1a08aa59359ebc32232eda50c98f013be49367e5d8b6a
build() {
    # copy our Setup included copied from the port dir
    cp -f Setup Modules/

    bonsai_configure \
        --with-computed-gotos \
        --without-ensurepip \
        --enable-optimizations

    # use our provided script to fix makesetup's bugged generated makefile
    sh fix_bad_makefile.sh

    bonsai_make altinstall maninstall
}
postbuild() {
    # Compile all .pyc files so they will be in the $pkg dir to be linked.
    # Otherwise they'll get created later and be in the root.
    # note: some of the dynamic modules may fail, this is fine, nop error code
    ./python -E Lib/compileall.py "${pkg:?}"/lib/$name${version%.*} 2>/dev/null ||:

    # create symlinks with full version numbers, (ie 3->3.7)
    ln -sf python${version%.*}         "$pkg"/bin/$name
    ln -sf python${version%.*}m-config "$pkg"/bin/$name-config
    ln -sf python${version%.*}m-config "$pkg"/bin/python${version%.*}-config
    ln -sf idle${version%.*}           "$pkg"/bin/idle3
    ln -sf pydoc${version%.*}          "$pkg"/bin/pydoc3
    ln -sf python${version%.*}         "$pkg"/lib/$name
    ln -sf python-${version%.*}.pc     "$pkg"/lib/pkgconfig/$name.pc

    # remove tests, readmes
    find "${pkg:?}" -type f -name 'test*' -o -name 'README*' -exec rm "{}" \;
}
