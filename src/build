# vi:syntax=sh
# shellcheck shell=sh

# runs build() method inside a pkgfile! -name readme 
# params: none
# asssumes: $pkgworkdir $name and all pkgfile vars in the environment
run_build() { 
    cd "$pkgworkdir" || die "build(): unable to cd to $pkgworkdir"
    msg "building $name..."

    # export all our flags to the environment
    getflags

    # workarounds for packaging that sucks
    sucks

    # run user defined prebuild(), if exists
    if defined prebuild ; then
        prebuild || die "$name prebuild() failed"
    # else, try to apply any patches (convenience)
    elif ! ismetapkg $name ; then
        bonsai_patch || die "$name generic prebuild() failed"
    fi

    cd "$pkgworkdir"

    # run user defined build(), if exists
    if defined build ; then
        build || die "$name build() failed"
    # otherwise run our automagic generic_build
    elif ! ismetapkg $name ; then
        case "$name" in
            *-bin) ;; # do not try to compile if binary package
            *) generic_build || die "$name generic_build() failed"
        esac
    fi

    # run user defined postbuild(), if exists
    cd "$pkgworkdir"
    if defined postbuild ; then
        postbuild || die "$name postbuild() failed"
    fi

    # strip bins/libs, making sure its not disabled in
    # either the pkgfile or the user's config
    if [ "$nostrip" != true ] && [ "$strip_bins" = true ] ; then
        if [ -d "$pkg"/bin ] || [ -d "$pkg"/lib ] ; then
            msg 'stripping binaries...'
            find "$pkg"/bin -type f 2>/dev/null | while read -r file ; do
                strip --strip-all "$file" 2>/dev/null ||:
            done &
            find "$pkg"/lib -type f 2>/dev/null | while read -r file ; do
                strip --strip-unneeded "$file" 2>/dev/null ||:
            done &
            wait
        fi
    fi

    # unset in case we are adding multiple packages
    unset -f prebuild build postbuild
    unset dir file
}

# * export all compilation related flags to environment
#
# * if given '--no-static' as an argument, will omit
#   all static-compilation related CFLAGS and LDFLAGS
#
# params: [--no-static]
getflags() {

    # 1. users config flags
    CFLAGS="$cflags"
    LDFLAGS="$ldflags"

    # 2. performance / general flags
    CFLAGS="$CFLAGS -Wl,--gc-sections -pipe"
    LDFLAGS="$LDFLAGS -fdata-sections -ffunction-sections"

    # 3. security flags
    CFLAGS="$CFLAGS -D_FORTIFY_SOURCE=2 -D_GLIBCXX_ASSERTIONS -Wformat \
-fexceptions -fstack-protector-strong -fstack-clash-protection \
-fasynchronous-unwind-tables -fcf-protection \
-Wl,-z,defs -Wl,-z,now -Wl,-z,relro -Wl,-z,noexecstack \
-Wl,-z,nodlopen -Wl,-z,nodump"

    # 4. static related flags
    case "$1" in
        --no-static) ;; # do not add static flags
        *)
            CFLAGS="$CFLAGS -static --static -Wl,-Bstatic -static-libgcc -no-pie -fpic \
-static-libstdc++ -static-libasan -static-libtsan -static-liblsan -static-libubsan"
            LDFLAGS="$LDFLAGS -static --static"
    esac

    TARGET=x86_64-linux-musl
    HOST="$(gcc -dumpmachine 2>/dev/null)" # will error if gcc is not yet installed
    BUILD="$HOST"
    LIBRARY_PATH=".:$root/lib:$root/libexec"
    CPATH=".:$root/include"
    AM_LDFLAGS="$LDFLAGS"
    CPPFLAGS="$CPPFLAGS $cppflags"
    CXXFLAGS="$CXXFLAGS $cxxflags"
    PREFIX="$pkgs/$name"
    prefix="$PREFIX"
    DESTDIR=''
    BINDIR="$PREFIX/bin"
    INCLUDEDIR="$PREFIX/include"
    LIBDIR="$PREFIX/lib"
    LIBEXECDIR="$PREFIX/libexec"
    MANDIR="$PREFIX/share/man"
    DOCDIR="$PREFIX/sucks"
    PRESERVEDIR="$root/var/preserve"
    cc="${cc:=$gcc}"
    CC="${cc:=$cc}"
    HOSTCC="$CC"
    SHELL=/bin/sh
    MAKEINFO=false
    if [ "$USE_HOST_PATH" ] ; then
        PKG_CONFIG_PATH="$root/lib/pkgconfig:$root/share/pkgconfig:\
/share/pkgconfig:/lib/pkgconfig:/usr/share/pkgconfig:/usr/lib/pkgconfig"
    else
        PKG_CONFIG_PATH="$root/lib/pkgconfig:$root/share/pkgconfig"
    fi
    export TARGET HOST BUILD CC cc HOSTCC SHELL \
           LIBRARY_PATH CPATH CFLAGS LDFLAGS CPPFLAGS CXXFLAGS \
           AM_LDFLAGS PREFIX prefix DESTDIR BINDIR INCLUDEDIR \
           LIBDIR LIBEXECDIR MANDIR DOCDIR PRESERVEDIR MAKEINFO \
           PKG_CONFIG_PATH
}

# convenience function, tries to find all *.patch
# in the top-level $work/$name directory and apply them
bonsai_patch() {
    find . ! -name . -prune -name "*.patch" | while read -r patch ; do
        { patch -p0 < "$patch" || return 1 ; } | msg
    done
    unset patch
}

bonsai_autogen() { ./autogen.sh "$@" || die "autogen.sh failed for $name" ; }

# if --path= param is provided, use ./"$path"/configure
# instead of assumed "./configure" (ie ./"$PWD"/configure)
# possible params: --path=""
bonsai_configure() {
    case "$1" in
        --path=*) configure_path="${1#--path=}" ; shift ;;
        *) configure_path="$PWD"
    esac

    # try to enable as many options as possible
    # if they are allowed in the configure script
    tmp_help="$work/$name.cfhelp"
    tmp_flags="$work/$name.cfflags"

    "$configure_path"/configure --help > "$tmp_help"
    :> "$tmp_flags"

    # params: flag_to_check flag_to_add
    addflag() {
        grep -F -- "$1" $tmp_help >/dev/null && 
            echo "$2" >> $tmp_flags
    }

    # -*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*
    # Global configure flags. These are applied to all packages.
    #
    # set in bonsai.rc:
    ${nls:=false}   || _nls=--disable-nls
    ${quiet:=false} && _quiet='--silent --quiet'   
    #
    # flags that are the same as what we check for
    for flag in --static --enable-static --enable-static-link --disable-shared \
                --without-shared --disable-rpath --disable-option-checking  \
                --enable-fast-install --disable-dependency-tracking --without-ada \
                --disable-libtool-lock --disable-largefile \
                --disable-docs --disable-gtk-docs --disable-gtk-docs-html \
                --disable-documentation --without-tests --disable-debug \
                --disable-debugger \
                $_quiet $_nls ; do
        addflag $flag $flag
    done
    #
    # flags that change based on what is in the --help
    addflag --target= --target="$TARGET"
    addflag --host= --host="$HOST"
    addflag --build= --build="$BUILD"
    addflag --enable-shared --disable-shared
    addflag --with-shared --without-shared
    addflag --disable-static --enable-static
    addflag --with-gnu-ld --without-gnu-ld
    addflag --with-debug --without-debug
    addflag --enable-tests --disable-tests
    addflag --with-tests --without-tests
    addflag --with-doc= --with-doc=no
    addflag --with-doxygen --without-doxygen
    addflag --enable-documentation --disable-documentation
    addflag --with-xmlto --without-xmlto
    addflag --with-fop --without-fop
    addflag --with-xsltproc --without-xsltproc
    addflag --prefix= --prefix="$PREFIX"
    addflag --bindir= --bindir="$BINDIR"
    addflag --sbindir= --sbindir="$BINDIR"
    addflag --libdir= --libdir="$LIBDIR"
    addflag --libexecdir= --libexecdir="$LIBEXECDIR"
    addflag --includedir= --includedir="$INCLUDEDIR"
    addflag --mandir= --mandir="$MANDIR"
    addflag --infodir= --infodir="$PREFIX"/sucks
    addflag --docdir= --docdir="$PREFIX"/sucks
    addflag --htmldir= --htmldir="$PREFIX"/sucks
    # -*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*

    # add a new line to denote separation between global flags
    # and argument-supplied flags
    echo >> "$tmp_flags"

    # add all argument-supplied flags to the flag file
    for flag in "$@" ; do echo "$flag" ; done >> "$tmp_flags"

    "$configure_path"/configure $(shellcat "$tmp_flags") || 
        die "configure failed for $name"

    unset -f addflag
    unset flag tmp_help _nls _quiet
}

bonsai_make() {
    # set in bonsai.rc:
    $mans   || _mans="MANDIR=$pkg/sucks"
    $quiet  && _quiet='-s'

    make $makeflags -j${jobs:=1} $_mans $_quiet \
        CC="$CC" \
        cc="$CC" \
        DESTDIR="$DESTDIR" \
        PREFIX="$PREFIX" \
        prefix="$PREFIX" \
        BINDIR="$BINDIR" \
        INCLUDEDIR="$INCLUDEDIR" \
        LIBDIR="$LIBDIR" \
        LIBEXECDIR="$LIBEXECDIR" \
        MANDIR="$MANDIR" \
        DOCDIR="$DOCDIR" \
        PRESERVEDIR="$PRESERVEDIR" "$@" || die "make $* failed for $name"

    unset _quiet
}

# run if pkgfile doesn't define a custom build()
generic_build() {
    if [ -s configure ] ; then
        bonsai_configure || return 1
    elif [ -s autogen.sh ] ; then
        bonsai_autogen || return 1
        bonsai_configure || return 1
    fi
    bonsai_make || return 1
    bonsai_make install || return 1
}
