# * relinks every package installed, used to fix broken / inconsistent symlinks
# * also used to bootstrap systems under a different $ROOT
# params: [--chroot]
relink_world() {
    # if no args, use the $PKGS variable from the bonsai.rc
    case "$1" in
        --chroot) relink_pkgs=/src/pkgs ;;
               *) relink_pkgs="$PKGS"
    esac
    msg "relinking world with \$PKGS=$relink_pkgs..."
    echo

    listpkgs | while read -r pkgid ; do
        pkg="$(pkgid2pkg "$pkgid")"
        if ! grep '^nolink=true$' "$(getpkgfile $pkg)" >/dev/null ; then
            # if its a metapkg, only link if it has a pkgdir
            ismetapkg "$pkg" && [ ! -d "$PKGS/$pkg" ] && continue
            linkpkg "$pkg" "$relink_pkgs"
        fi
    done || die "relink_world(): linking failed"

    echo
    msg 'done!'
}
