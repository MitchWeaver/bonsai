# adds a port
# params: $pkgname
addpkg() {
    [ "$(ls $ports | wc -l)" -gt 0 ] || die "addpkg(): no ports found"

    pkgname=$1
    pkgfile="$ports"/$pkgname/pkgfile
    isinst $pkgname > /dev/null && die "port $pkgname is already installed"

    # make sure these are unset before sourcing pkgfile
    unset depends deps version source

    [ -f "$pkgfile" ] || die "addpkg(): could not source $pkgname's pkgfile"
    name=$pkgname . "$pkgfile"

    for dep in $depends $deps ; do
        isinst $dep > /dev/null || die "addpkg(): port $pkgname depends on pkg \"$dep\""
    done

    [ -z "$version" ] && version='unknown'
    pkgid="${pkgname}${delim}${version}"

    get "$source" $pkgname "$version"

    cd "$work/$pkgname" || die "addpkg(): unable to cd to $work/$pkgid"

    mkdir -p "$pkgs"/$pkgname
    trap "rmdir "$pkgs"/$pkgname" ERR SIGINT SIGKILL SIGTERM

    run_build $pkgname || die "$pkgname failed to build"

    sanity_check && rm -rf "$work/$pkgid"

    link_pkg $pkgname || die "$pkgname failed to link"

    clear_junk $pkgname
    add_db $pkgname $version
    msg "$pkgname installed!"
    clean

    trap - ERR SIGINT SIGKILL SIGTERM
    unset pkgname pkgfile version pkgid
}
# vi:syntax=sh
