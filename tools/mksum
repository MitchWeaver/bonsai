#!/bin/sh
#
# tool to quickly generate checksum files for ports
#
# http://github.com/bonsai-linux/bonsai
#

# find $name.sources file in $PWD
sources=$(printf '%s\n' ./*.sources)
[ -f "$sources" ] || die "no sources file found in \$PWD"
:>"$sources".sums

# file syntax:
#
# $url  $checksum
# $url2 $checksum2
# $url3 $checksum3
# ...
while read -r line ; do
    url=${line% *}

    # if file exists, it is a local file (not an actual url)
    [ -e "$url" ] && continue

    # make temp dir to download file
    dl=/tmp/mksum-${url##*/}
    mkdir -p "$dl"

    # download and checksum, appending to temp file
    curl -qL#C - --url "$url" -o "$dl/${url##*/}" || exit 1
    set -- $(sha512sum "$dl/${url##*/}")
    printf '%s %s\n' "$url" "$1" >>"$sources".sums

    # remove the temp dir
    rm -r "$dl"
done <"$sources"

mv -f "$sources".sums "$sources"

# add checksums of all port's files, ex: patches, omitting leading './'
find . -type f ! -name . ! -name '*.pkgfile' ! -name '*.sources' | \
while read -r file ; do
    set -- $(sha512sum "$file")
    printf '%s %s\n' "${2#./}" "$1"
done >>"$sources"
